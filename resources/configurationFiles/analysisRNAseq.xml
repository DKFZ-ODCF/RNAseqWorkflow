<configuration name='RNAseqAnalysis' description='paired end RNA seq analysis using STAR, feature counts, kallisto, arriba, RNAseQC and QualiMap2'
               configurationType='analysis' class='de.dkfz.roddy.core.Analysis'
               workflowClass='de.dkfz.b080.co.rnaseqworkflow.RNAseqWorkflow'
               runtimeServiceClass='de.dkfz.b080.co.common.COProjectsRuntimeService'
               listOfUsedTools=""
               usedToolFolders="rnaseqworkflow,tools"
               cleanupScript="cleanupScript">

    <configurationvalues>
        <!-- ## Imported from cofilenames -->
        <cvalue name='sampleDirectory' value='${inputBaseDirectory}/${pid}/${sample}/${library}/${SEQUENCER_PROTOCOL}' type='path'/>
        <cvalue name='sequenceDirectory' value='${sampleDirectory}/${run}/sequence' type='path'/>
        <cvalue name='mergedBamSuffix_markDuplicatesShort' value='merged.mdup.bam' type="string" />
        <cvalue name='mergedBamSuffixList' value='${mergedBamSuffix_markDuplicatesShort}' type="string" description="A list of all known suffixes for merged bam files. I.e. merged.dupmark.bam, merged.mdup.bam..." />
        <cvalue name='defaultMergedBamSuffix' value='${mergedBamSuffix_markDuplicatesShort}' type="string" description="The default suffix for merged bam files when they are created by Roddy." />
        <!-- ## Imported from cobase project -->
        <cvalue name='possibleControlSampleNamePrefixes' value='( blood BLOOD normal control CONTROL buffy_coat GERMLINE )' type='bashArray'/>
        <cvalue name='possibleTumorSampleNamePrefixes' value='( tumor TUMOR metastasis xenograft disease DISEASE relapse RELAPSE autopsy AUTOPSY metastasis METASTASIS )' type='bashArray'/>
        <cvalue name='possibleSingleCellSampleNamePrefixes' value='( SingleCell single_cell )' type='bashArray'/>
        <cvalue name="useCentralAnalysisArchive" value="true"/>
        <cvalue name="enableJobProfiling" value="false"/>
        <cvalue name='QUAL' value='phred' description="Default quality is phred, can be illumina."/>
        <!-- ## Imported from commonCOWorkflowsSettings -->
        <cvalue name='SEQUENCER_PROTOCOL' value='paired' type="string"  description="only paired read sequencing is currently supported"/>

        <!-- ## -->
        <!-- ## SOME RUNTIME_CONFIG PARMS -->
        <!-- ## -->
        <cvalue name='CORES' value='8' type='string'/>
        <cvalue name='TEST_RUN' value='false' type='boolean' description="only print the commands and doesnt execute them"/>
        <cvalue name='DO_FIRST' value='echo "Do something first"' type='string' description="incase something needs to be run at the start of the workflow"/>

        <!-- ## DIRECTORIES -->
        <cvalue name='alignmentOutputDirectory' value='alignment' type='string'/>
        <cvalue name='qcOutputDirectory' value='qualitycontrol' type='string'/>
        <cvalue name='ALIGNMENT_DIR' value='${outputAnalysisBaseDirectory}/${alignmentOutputDirectory}' type='string'/>
        <!--<cvalue name='SCRATCH' value='${outputAnalysisBaseDirectory}/temp_${SAMPLE}_${PID}' type='string'/>-->
        <cvalue name='SCRATCH' value='${RODDY_SCRATCH}' type='string'/>
        <cvalue name='COUNT_DIR' value='${outputAnalysisBaseDirectory}/featureCounts' type='string'/>
        <cvalue name='COUNT_DIR_EXON' value='${outputAnalysisBaseDirectory}/featureCounts_dexseq' type='string'/>
        <cvalue name='KALLISTO_UN_DIR' value='${outputAnalysisBaseDirectory}/kallisto_un' type='string'/>
        <cvalue name='KALLISTO_FR_DIR' value='${outputAnalysisBaseDirectory}/kallisto_fr' type='string'/>
        <cvalue name='KALLISTO_RF_DIR' value='${outputAnalysisBaseDirectory}/kallisto_rf' type='string'/>
        <cvalue name='QC_DIR' value='${outputAnalysisBaseDirectory}/$qcOutputDirectory' type='string'/>
        <cvalue name='RNASEQC_DIR' value='${QC_DIR}/RNAseQC' type='string'/>
        <cvalue name='QUALIMAP_DIR' value='${QC_DIR}/QualiMap2' type='string'/>
        <cvalue name='ARIBA_DIR' value='${outputAnalysisBaseDirectory}/fusions_ariba' type='string'/>

        <!-- # RUNTIME_CONFIG_OUTFILE DEFINITITIONS -->
        <cvalue name='STAR_PREFFIX' value='${SAMPLE}_${PID}_merged' type='string'/>
        <cvalue name='STAR_CHIMERA_PREFFIX' value='${SAMPLE}_${PID}_chimeric_merged' type='string'/>
        <cvalue name='STAR_NOTSORTED_BAM' value='$STAR_PREFFIX.Aligned.out.bam' type='string'/>
        <cvalue name='STAR_SORTED_BAM' value='$STAR_PREFFIX.Aligned.sortedByCoord.out.bam' type='string'/>
        <cvalue name='STAR_SORTED_MKDUP_BAM' value='$STAR_PREFFIX.mdup.bam' type='string'/>
        <cvalue name='STAR_CHIMERA_SAM' value='$STAR_PREFFIX.Chimeric.out.sam' type='string'/>
        <cvalue name='STAR_CHIMERA_BAM_PREF' value='$STAR_PREFFIX.Chimeric.out' type='string'/>
        <cvalue name='STAR_CHIMERA_MKDUP_BAM' value='$STAR_CHIMERA_PREFFIX.mdup.bam' type='string'/>

        <!-- ## -->
        <!-- ## SOFTWARE STACK -->
        <!-- ## -->
        <cvalue name='JEMULTIPLEXER_JAR' value='/home/parkj/opt/jemultiplexer_1.0.6_bundle.jar' type='string'/>

        <cvalue name='STAR_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/STAR/STAR-2.5.2b/bin/STAR' type='string'/>
        <cvalue name='FEATURECOUNTS_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/subread/1.5.1/bin/featureCounts' type='string'/>
        <cvalue name='SAMBAMBA_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/sambamba/sambamba-0.6.5/sambamba' type='string'/>
        <cvalue name='SAMTOOLS_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/bin/samtools-1.3.1' type='string'/>
        <cvalue name='RNASEQC_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/RNA-SeQC/RNA-SeQC-1.1.8/rnaseqc' type='string'/>
        <cvalue name='KALLISTO_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/bin/kallisto-0.43.0' type='string'/>
        <cvalue name='QUALIMAP_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/qualimap/qualimap-2.2.1/qualimap' type='string'/>
        <cvalue name='ARIBA_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/arriba/arriba-0.8/bin/arriba' type='string'/>
        <cvalue name='ARIBA_READTHROUGH_BINARY' value='/ibios/tbi_cluster/13.1/x86_64/ariba/ariba-0.8/bin/extract_read-through_fusions' type='string'/>
        <cvalue name='ARIBA_DRAW_FUSIONS' value='/ibios/tbi_cluster/13.1/x86_64/ariba/ariba-0.8/bin/draw_fusions.R' type='string'/>
        <cvalue name="JOB_PROFILER_BINARY" value="strace.sh"/>
         <!-- ## MODULE OPTIONS -->
        <cvalue name='LOAD_MODULE' value='true' type='boolean'/>
        <cvalue name='MODULE_ENV' value='HIPO2_rna/v1' type='string'/>

        <!-- ## -->
        <!-- ## WHAT TO RUN -->
        <!-- ## -->
        <cvalue name='RUN_STAR' value='true' type='boolean'/>
        <cvalue name='RUN_FEATURE_COUNTS' value='true' type='boolean'/>
        <cvalue name='RUN_FEATURE_COUNTS_DEXSEQ' value='true' type='boolean'/>
        <cvalue name='RUN_RNASEQC' value='true' type='boolean'/>
        <cvalue name='RUN_QUALIMAP' value='false' type='boolean'/>
        <cvalue name='RUN_KALLISTO' value='false' type='boolean'/>
        <cvalue name='RUN_ARIBA' value='true' type='boolean'/>
        <cvalue name='RUN_QCJSON' value='true' type='boolean'/>
        <cvalue name='RUN_CLEANUP' value='true' type='boolean'/>

        <!-- ## -->
        <!-- ## DATABASE/FILE STACK -->
        <!-- ## -->
        <cvalue name='GENOME_FA' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/indexes/bwa/bwa06_1KGRef_Phix/hs37d5_PhiX.fa' type='string'/>
        <cvalue name='GENOME_GATK_INDEX' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/indexes/bwa/bwa06_1KGRef_Phix/hs37d5_PhiX.fa' type='string'/>
        <cvalue name='GENE_MODELS' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/databases/gencode/gencode19/gencode.v19.annotation_plain.gtf' type='string'/>
        <cvalue name='GENE_MODELS_EXCLUDE' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/databases/gencode/gencode19/gencode.v19.annotation_plain.chrXYMT.rRNA.tRNA.gtf' type='string'/>
        <cvalue name='GENE_MODELS_DEXSEQ' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/databases/gencode/gencode19/gencode.v19.annotation_plain.dexseq.gff' type='string'/>
        <cvalue name='GENE_MODELS_GC' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/databases/gencode/gencode19/gencode.v19.annotation_plain.transcripts.autosomal_transcriptTypeProteinCoding_nonPseudo.1KGRef.gc' type='string'/>
        <cvalue name='GENOME_STAR_INDEX_50' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/indexes/STAR/STAR_2.5.2b_1KGRef_PhiX_Gencode19_50bp' type='string'/>
        <cvalue name='GENOME_STAR_INDEX_100' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/indexes/STAR/STAR_2.5.2b_1KGRef_PhiX_Gencode19_100bp' type='string'/>
        <cvalue name='GENOME_STAR_INDEX_200' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/indexes/STAR/STAR_2.5.2b_1KGRef_PhiX_Gencode19_200bp' type='string'/>
        <cvalue name='GENOME_KALLISTO_INDEX' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/indexes/kallisto/kallisto-0.43.0_1KGRef_Gencode19_k31/kallisto-0.43.0_1KGRef_Gencode19_k31.index' type='string'/>
        <cvalue name='ARIBA_KNOWN_FUSIONS' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/tools_data/ariba/known_fusions_CancerGeneCensus_gencode19_2017-01-16.tsv.gz' type='string'/>
        <cvalue name='ARIBA_BLACKLIST' value='/icgc/ngs_share/assemblies/hg19_GRCh37_1000genomes/tools_data/ariba/blacklist_hs37d5_gencode19_2017-01-09.tsv.gz' type='string'/>

        <!-- ## -->
        <!-- ## SOFTWARE PARAMS -->
        <!-- ## -->
        <!-- ## STAR -->
        <cvalue name='READ_COMMAND' value='"${UNZIPTOOL} ${UNZIPTOOL_OPTIONS}"' type='string'/>
        <cvalue name='ADAPTER_SEQ' value="AATGATACGGCGACCACCGAGATCTACACTCTTTCCCTACACGACGCTCTTCCGATCT" type='string'/>
        <cvalue name='STAR_PARAMS_CLIP' value='"--clip3pAdapterSeq ${ADAPTER_SEQ}"' type='string'/>
        <cvalue name='STAR_PARAMS_BASIC'
                value='"--sjdbOverhang 200 --runThreadN $CORES --outFileNamePrefix $STAR_PREFFIX. --genomeDir ${GENOME_STAR_INDEX_200} --runRNGseed 1234 --outTmpDir $SCRATCH/${SAMPLE}_${PID}_STAR"'
                type='string'/>
        <cvalue name='STAR_PARAMS_OUT'
                value='"--outSAMtype BAM Unsorted SortedByCoordinate --limitBAMsortRAM 100000000000 --outBAMsortingThreadN=1 --outSAMstrandField intronMotif --outSAMunmapped Within KeepPairs --outFilterMultimapNmax 1 --outFilterMismatchNmax 5 --outFilterMismatchNoverLmax 0.3"'
                type='string'/>
        <cvalue name='STAR_PARAMS_2PASS' value='"--twopassMode Basic --twopass1readsN -1 --genomeLoad NoSharedMemory"' type='string'/>
        <cvalue name='STAR_PARAMS_CHIMERIC' value='"--chimSegmentMin 15 --chimScoreMin 1 --chimScoreJunctionNonGTAG 0 --chimJunctionOverhangMin 15  --chimSegmentReadGapMax 3 --alignSJstitchMismatchNmax 5 -1 5 5"' type='string'/>
        <cvalue name='STAR_PARAMS_INTRONS' value='"--alignIntronMax 1100000 --alignMatesGapMax 1100000 --alignSJDBoverhangMin 3 --alignIntronMin 20"' type='string'/>
        <cvalue name='STAR_PARAMS_ADDITIONAL' value='" "'  type='string'/>
        <cvalue name='STAR_PARAMS' value='"$STAR_PARAMS_BASIC $STAR_PARAMS_OUT $STAR_PARAMS_2PASS $STAR_PARAMS_CHIMERIC $STAR_PARAMS_INTRONS $STAR_PARAMS_CLIP $STAR_PARAMS_ADDITIONAL"' type='string'/>
        <cvalue name='JSON_PREFIX' value='"${SAMPLE}_${PID}_"' type='string'/>

        <!-- ## -->
        <!-- ## Default file acces -->
        <cvalue name='outputFileGroup' value='B080'/>
        <cvalue name='outputUMask' value='007' type='string'/>
        <cvalue name='outputAccessRights' value='u+rw,g+rw,o-rwx'/>
        <cvalue name='outputAccessRightsForDirectories' value='u+rwx,g+rwx,o-rwx'/>
        <cvalue name='outputAllowAccessRightsModification' value='false' type="boolean"/>
    </configurationvalues>

    <processingTools>
        <tool name="navLib" value="navBashLib.sh" basepath="rnaseqworkflow"/>
        <tool name="bashLib" value="bashLib.sh" basepath="rnaseqworkflow"/>
        <tool name="workflowLib" value="workflowLib.sh" basepath="rnaseqworkflow"/>
        <tool name="cleanupScript" value="cleanupScript.sh" basepath="rnaseqworkflow">
            <resourcesets>
                <rset size="l" memory="0.1" cores="1" nodes="1" walltime="1"/>
            </resourcesets>
        </tool>

        <tool name="countsToFpkmTpm" value="featureCounts_2_FpkmTpm" basepath="rnaseqworkflow"/>
        <tool name="countsdexseqToFpkmTpm" value="featureCountsDexseq_2_FpkmTpm" basepath="rnaseqworkflow"/>
        <tool name="kallistoRescale" value="kallistoRescaleTPM" basepath="rnaseqworkflow"/>
        <tool name="createJsonFromOutput" value="qcJson" basepath="rnaseqworkflow"/>

        <tool name="jemultiplexer" value="scrna_demultiplexing.sh" basepath="rnaseqworkflow">
            <resourcesets>
                <rset size="s" memory="50g" cores="5" nodes="1" walltime="3h" queue="devel"/>
                <rset size="l" memory="100g" cores="10" nodes="1" walltime="48h"/>
            </resourcesets>
            <input type="file" typeof="LaneFile" scriptparameter="FAKE_FILE"/>
            <input type="string" setby="callingCode" scriptparameter="SAMPLE"/>
            <input type="string" setby="callingCode" scriptparameter="READ_LEFT"/>
            <input type="string" setby="callingCode" scriptparameter="READ_RIGHT"/>
            <output type="filegroup" scriptparameter="READS_DEMULTIPLEXED"/>
        </tool>

        <tool name="starAlignment" value="HIPO2_rnaseq_processing.sh" basepath="rnaseqworkflow">
            <resourcesets>
                <rset size="s" memory="37g" cores="4" nodes="1" walltime="3h" queue="devel"/>
                <rset size="l" memory="100g" cores="8" nodes="1" walltime="48h"/>
            </resourcesets>
            <input type="file" typeof="LaneFile" scriptparameter="FAKE_FILE"/>
            <input type="string" setby="callingCode" scriptparameter="SAMPLE"/>
            <input type="string" setby="callingCode" scriptparameter="READS_STAR_LEFT"/>
            <input type="string" setby="callingCode" scriptparameter="READS_STAR_RIGHT"/>
            <input type="string" setby="callingCode" scriptparameter="READS_KALLISTO"/>
            <input type="string" setby="callingCode" scriptparameter="PARM_RUNIDS"/>
            <input type="string" setby="callingCode" scriptparameter="PARM_LANEIDS"/>
            <input type="string" setby="callingCode" scriptparameter="PARM_READGROUPS"/>
            <output type="file" typeof="BamFile" scriptparameter="STAR_SORTED_MKDUP_BAM">
                <output type="file" variable="indexFile" typeof="BamIndexFile" scriptparameter="STAR_SORTED_MKDUP_BAM_INDEX"/>
            </output>
        </tool>

    </processingTools>
    <filenames package='de.dkfz.b080.co.files' filestagesbase='de.dkfz.b080.co.files.COFileStage'>
        <filename class='BamFile' onTool="starAlignment" pattern='${outputAnalysisBaseDirectory}/${alignmentOutputDirectory}/${STAR_PREFFIX}.mdup.bam'/>
        <!--<filename class='BamFile' onTool="rna_processing" pattern='${outputAnalysisBaseDirectory}/${alignmentOutputDirectory}/${pid}.${sample}.sorted.mkdup.bam'/>-->
        <!--<filename class='BasicBamFile' onTool="starAlignment" onScriptParameter="starAlignment:STAR_SORTED_MKDUP_BAM" pattern='${outputAnalysisBaseDirectory}/${alignmentOutputDirectory}/${pid}.${sample}.sorted.mkdup.bam' />-->
        <filename class='BamIndexFile' derivedFrom='BamFile' pattern='${sourcefile}.bai'/>
    </filenames>
</configuration>
